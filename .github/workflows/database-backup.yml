name: Database Backup

on:
  # –î–æ–ª–æ–æ —Ö–æ–Ω–æ–≥ –±“Ø—Ä –ù—è–º –≥–∞—Ä–∞–≥—Ç 02:00 UTC-–¥ –∞–∂–∏–ª–ª–∞–Ω–∞
  schedule:
    - cron: '0 2 * * 0'

  # –ì–∞—Ä–∞–∞—Ä —á –∞–∂–∏–ª–ª—É—É–ª–∂ –±–æ–ª–Ω–æ (GitHub Actions tab –¥—ç—ç—Ä "Run workflow" –¥–∞—Ä–∞—Ö)
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          # Install prerequisites for PostgreSQL repository
          sudo apt-get install -y wget gnupg2 lsb-release
          
          # Add PostgreSQL Global Development Group (PGDG) repository for PostgreSQL 17
          echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" | sudo tee /etc/apt/sources.list.d/pgdg.list
          
          # Add PostgreSQL signing key
          wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
          
          # Update package list with new repository
          sudo apt-get update
          
          # Install PostgreSQL 17 client (matches Supabase server version 17.6)
          sudo apt-get install -y postgresql-client-17

          # Version —à–∞–ª–≥–∞—Ö
          psql --version

      - name: Create database backup
        env:
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_HOST: ${{ secrets.SUPABASE_HOST }}
          SUPABASE_USER: ${{ secrets.SUPABASE_USER }}
          SUPABASE_DB: ${{ secrets.SUPABASE_DB }}
        run: |
          echo "üîÑ Database backup —ç—Ö—ç–ª–∂ –±–∞–π–Ω–∞..."
          echo "üìÖ –û–≥–Ω–æ–æ: $(date)"
          echo ""

          # Backup “Ø“Ø—Å–≥—ç—Ö
          pg_dump -h "$SUPABASE_HOST" \
                  -U "$SUPABASE_USER" \
                  -d "$SUPABASE_DB" \
                  -F c \
                  --no-owner \
                  --no-acl \
                  -f backup-$(date +%Y%m%d-%H%M%S).dump

          echo ""
          echo "üì¶ Backup —Ñ–∞–π–ª—ã–Ω –º—ç–¥—ç—ç–ª—ç–ª:"
          ls -lh backup-*.dump

          echo ""
          echo "üîç Backup –∞–≥—É—É–ª–≥–∞ —à–∞–ª–≥–∞–∂ –±–∞–π–Ω–∞..."
          pg_restore --list backup-*.dump | head -30

          echo ""
          echo "‚úÖ Backup –∞–º–∂–∏–ª—Ç—Ç–∞–π “Ø“Ø—Å–ª—ç—ç!"

      - name: Upload backup artifact
        uses: actions/upload-artifact@v6
        with:
          name: database-backup-${{ github.run_number }}
          path: backup-*.dump
          retention-days: 30

      - name: Backup summary
        if: success()
        run: |
          echo "========================================" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Database Backup –ê–º–∂–∏–ª—Ç—Ç–∞–π" >> $GITHUB_STEP_SUMMARY
          echo "========================================" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üì¶ **Backup —Ñ–∞–π–ª:** \`database-backup-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
          echo "üìÖ **–û–≥–Ω–æ–æ:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "üíæ **–•—ç–º–∂—ç—ç:** $(du -h backup-*.dump | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "‚è∞ **Retention:** 30 —Ö–æ–Ω–æ–≥" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### –•—ç—Ä—Ö—ç–Ω —Ç–∞—Ç–∞–∂ –∞–≤–∞—Ö –≤—ç?" >> $GITHUB_STEP_SUMMARY
          echo "1. Actions tab –¥—ç—ç—Ä –æ—á–∏—Ö" >> $GITHUB_STEP_SUMMARY
          echo "2. –≠–Ω—ç workflow-–≥ —Å–æ–Ω–≥–æ—Ö" >> $GITHUB_STEP_SUMMARY
          echo "3. –î–æ–æ—à scroll —Ö–∏–π–∂ 'Artifacts' —Ö—ç—Å—ç–≥ –æ–ª–æ—Ö" >> $GITHUB_STEP_SUMMARY
          echo "4. \`database-backup-${{ github.run_number }}\` —Ç–∞—Ç–∞–∂ –∞–≤–∞—Ö" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Restore —Ö–∏–π—Ö:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "./scripts/restore-database.sh backup-YYYYMMDD-HHMMSS.dump" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Backup failure notification
        if: failure()
        run: |
          echo "‚ùå Database backup –ê–õ–î–ê–ê –≥–∞—Ä–ª–∞–∞!"
          echo "Logs-–≥ —à–∞–ª–≥–∞–∂, –∞–ª–¥–∞–∞–≥ –∑–∞—Å–Ω–∞ —É—É."
          exit 1
